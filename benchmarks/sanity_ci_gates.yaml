# Sanity Pyramid CI Gates Configuration
# Hard gates for pass/fail determination in continuous integration

sanity_pyramid:
  version: "1.0"
  description: "Evidence sufficiency validation gates for code search and RAG"

# ESS Thresholds per operation type
ess_thresholds:
  locate: 0.8      # Symbol/path finding - high precision required
  extract: 0.75    # Code span extraction - very high precision  
  explain: 0.6     # Natural language explanation - more flexible
  compose: 0.7     # Multi-file composition - good context needed
  transform: 0.65  # Usage examples - moderate precision

# Hard CI Gates (all must pass)
hard_gates:
  
  # Pre-generation gates (block if fail)
  pre_generation:
    overall_pass_rate:
      threshold: 0.85
      description: "Weighted pass rate across all operations"
      failure_action: "block_build"
    
    per_operation_minimums:
      locate:
        threshold: 0.90
        description: "Locate operations must be highly reliable"
      extract: 
        threshold: 0.85
        description: "Extract operations require high precision"
      explain:
        threshold: 0.70
        description: "Explain operations allow more flexibility"
      compose:
        threshold: 0.75
        description: "Compose operations need good context"
      transform:
        threshold: 0.70
        description: "Transform operations are moderately strict"
  
  # Attribution integrity gates
  attribution:
    citation_at_1:
      threshold: 1.0
      description: "Every answer must cite at least one retrieved path"
      failure_action: "block_build"
    
    extract_substring_match:
      threshold: 1.0
      description: "Extract answers must be substring of context"
      failure_action: "block_build"
      
    code_percentage_minimum:
      threshold: 0.70
      description: "Code operations require ≥70% code tokens in context"
      applies_to: ["code.func", "code.symbol", "code.regex", "code.repo", "code.trace"]
  
  # Evidence sufficiency drift detection
  drift_detection:
    ess_median_drift:
      threshold: 0.05
      description: "Median ESS by operation must not drop >5% vs baseline"
      baseline_method: "last_green_commit"
      failure_action: "warn_and_investigate"
    
    answerable_at_k_minimum:
      threshold: 0.70
      description: "Answerable@k must be ≥70% on core set"
      failure_action: "block_build"
      
    span_recall_minimum:
      threshold: 0.50
      description: "SpanRecall must be ≥50% for locate/extract operations"
      applies_to: ["locate", "extract"]
      failure_action: "block_build"
  
  # Ablation sensitivity (evidence dependency validation)
  ablation:
    shuffle_context_sensitivity:
      threshold: 0.10
      description: "Context shuffle must reduce answer F1 by ≥10%"
      failure_action: "warn_and_investigate"
      reason: "Guards against answer-without-evidence"
    
    drop_top1_sensitivity:
      threshold: 0.05
      description: "Dropping top-1 chunk should impact answers"
      failure_action: "warn_and_investigate"
    
    ess_answer_correlation:
      threshold: 0.4
      description: "ESS scores should correlate with answer quality"
      failure_action: "warn_and_investigate"
  
  # Performance and latency budgets
  performance:
    retrieval_latency_p95:
      code_search: 200  # ms
      rag_code_qa: 350  # ms
      rag_api_qa: 300   # ms
      rag_design_qa: 400 # ms
      description: "P95 retrieval latency budgets by scenario"
      failure_action: "warn_with_waiver_option"
    
    total_context_tokens:
      maximum: 8000
      description: "Hard limit on total context tokens"
      failure_action: "block_build"

# Core query set requirements  
core_query_set:
  minimum_size: 150
  target_size: 200
  
  per_operation_minimum: 25
  description: "Each operation×repo must have ≥25 queries"
  
  negative_controls: 10
  description: "Include negative controls (shuffled/off-corpus queries)"
  
  repositories:
    minimum: 2
    recommended: 3
    description: "Distribute queries across multiple repositories"

# Reporting and diagnostics
reporting:
  required_sections:
    - "Sanity Pass Rate (Pre-Gen)"
    - "ESS Histogram by Operation" 
    - "Top Failure Reasons"
    - "Ablation Deltas"
    - "Hard Gates Status"
  
  failure_taxonomy:
    - "No gold path in retrieval"
    - "SpanRecall below threshold"
    - "Key token miss"
    - "Insufficient code percentage"
    - "ESS below operation threshold"
    - "Context token budget exceeded"
  
  system_comparison:
    description: "Compare systems only on queries that pass sanity gates"
    metrics: ["Success@1", "MRR", "NDCG", "ContextPrecision", "ContextRecall"]

# Calibration and maintenance
calibration:
  ess_threshold_tuning:
    method: "ROC/PR curve optimization on labeled set"
    labeled_set_size: 100
    target_metric: "balanced_accuracy"
    rerun_frequency: "quarterly"
  
  core_set_expansion:
    trigger: "new_repository_added OR scenario_added"
    process: "maintain_operation_distribution"
    review_frequency: "monthly"

# CI integration
ci_integration:
  failure_modes:
    block_build:
      - "overall_pass_rate < 85%"
      - "any_operation_below_minimum"
      - "attribution_integrity_failure"
      - "answerable_at_k < 70%"
      - "span_recall_failure"
      - "context_token_budget_exceeded"
    
    warn_and_investigate:
      - "ess_drift > 5%"
      - "ablation_sensitivity_failure"
      - "ess_answer_correlation_low"
    
    warn_with_waiver:
      - "latency_budget_exceeded"
  
  report_attachments:
    - "ess_distribution_diff.png"
    - "failure_taxonomy_summary.json"
    - "sanity_scorecard.md"
    - "recommended_fixes.yaml"

# Emergency procedures
emergency:
  escalation_triggers:
    - "hard_gates_failing > 3_consecutive_commits"
    - "overall_pass_rate < 50%"
    - "evidence_completely_disconnected (correlation < 0.1)"
  
  fallback_actions:
    - "revert_to_last_green_baseline"
    - "disable_affected_scenarios_temporarily"
    - "alert_retrieval_team_for_debugging"